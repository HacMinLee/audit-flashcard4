<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학민maden: 회계감사 암기 앱</title>
    <link rel="manifest" href="./manifest.json">
    
    <meta name="theme-color" content="#1a202c">
    <link rel="icon" href="https://raw.githubusercontent.com/HacMinLee/audit-flashcard4/main/audit.png" sizes="32x32">
    <link rel="icon" href="https://raw.githubusercontent.com/HacMinLee/audit-flashcard4/main/audit.png" sizes="192x192">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/HacMinLee/audit-flashcard4/main/audit.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Song+Myung&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; scroll-behavior: smooth; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; }
        .font-title { font-family: 'Song Myung', serif; }
        .font-noble-script { font-family: 'Pinyon Script', cursive; }
        .screen { display: none; height: 100%; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .screen.active { display: flex; flex-direction: column; opacity: 1; }
        .accordion-content { display: none; }
        .accordion-item.open > .accordion-content { display: block; }
        .accordion-item.open > .accordion-toggle { background-color: #f5f5f4; } /* 목차 하이라이트 */
        .accordion-toggle .chevron { transition: transform 0.2s ease-in-out; }
        .accordion-item.open > .accordion-toggle .chevron { transform: rotate(90deg); }
        .main-btn {
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .main-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #flashcard-answer { transition: opacity 0.2s ease-in-out; } /* 정답 애니메이션 */

         /* 스크롤바 디자인 */
        #accordion-container::-webkit-scrollbar,
        #flashcard-answer::-webkit-scrollbar,
        #announcement-content::-webkit-scrollbar { width: 6px; }
        #accordion-container::-webkit-scrollbar-track,
        #flashcard-answer::-webkit-scrollbar-track,
        #announcement-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #accordion-container::-webkit-scrollbar-thumb,
        #flashcard-answer::-webkit-scrollbar-thumb,
        #announcement-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #accordion-container::-webkit-scrollbar-thumb:hover,
        #flashcard-answer::-webkit-scrollbar-thumb:hover,
        #announcement-content::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center p-2 sm:p-4">

    <div class="container mx-auto max-w-lg w-full h-full bg-stone-50 rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-slate-200">
        
        <div id="loading-screen" class="screen active p-8 justify-center items-center text-center">
            <h1 class="text-3xl font-bold text-slate-900 mb-4">학민 maden</h1>
            <p id="loading-status" class="text-slate-500">데이터를 불러오는 중입니다...</p>
        </div>

        <div id="main-screen" class="screen p-8 justify-center text-center">
             <header class="relative mb-10">
                 <h1 class="text-4xl font-title text-slate-700">회계감사 암기 보조</h1>
                 <p class="font-noble-script text-slate-600 mt-2 text-3xl">Hakmin maden</p>
                 <button id="install-pwa-btn" class="hidden absolute -top-4 right-0 bg-slate-200 text-slate-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-slate-300 transition">앱 설치</button>
             </header>
             <main class="flex flex-col space-y-4 px-8">
                 <button id="start-study-btn" class="main-btn w-full bg-gradient-to-br from-sky-200 to-violet-200 text-sky-800 font-bold py-4 px-6 rounded-xl shadow-lg">학습 시작</button>
                 <button id="view-checked-btn" class="main-btn w-full bg-gradient-to-br from-stone-200 to-stone-300 text-stone-700 font-bold py-4 px-6 rounded-xl shadow-lg">★ 체크된 문제 보기</button>
                 <button id="random-question-btn" class="main-btn w-full bg-gradient-to-br from-teal-200 to-lime-200 text-teal-800 font-bold py-4 px-6 rounded-xl shadow-lg">랜덤 물음</button>
                 <button id="announcement-btn" class="main-btn w-full bg-gradient-to-br from-slate-200 to-slate-300 text-slate-700 font-bold py-4 px-6 rounded-xl shadow-lg">공지사항</button>
             </main>
        </div>

        <div id="selection-screen" class="screen p-6 md:p-8">
             <header class="mb-6 flex justify-between items-center flex-shrink-0">
                 <h2 id="selection-title" class="text-2xl font-bold text-slate-700">학습 범위 선택</h2>
                 <button id="back-to-main-btn" class="text-sm text-slate-500 hover:text-slate-800 transition-colors"> &lt; 처음으로</button>
             </header>
             <div id="accordion-container" class="space-y-2 overflow-y-auto pr-2"></div>
        </div>

        <div id="random-selection-screen" class="screen p-8 justify-center text-center">
            <header class="mb-10 flex justify-center items-center relative">
                <button id="back-to-main-from-random-btn" class="absolute left-0 text-sm text-slate-500 hover:text-slate-800 transition-colors"> &lt; 처음으로</button>
                <h2 class="text-2xl font-bold text-slate-700">랜덤 물음 방식 선택</h2>
            </header>
            <main class="flex flex-col space-y-4 px-8">
                <button id="random-all-btn" class="main-btn w-full bg-gradient-to-br from-teal-200 to-lime-200 text-teal-800 font-bold py-4 px-6 rounded-xl shadow-lg">전체 문제 중 랜덤</button>
                <button id="random-checked-btn" class="main-btn w-full bg-gradient-to-br from-amber-200 to-orange-200 text-amber-800 font-bold py-4 px-6 rounded-xl shadow-lg">체크된 문제 중 랜덤</button>
            </main>
        </div>

        <div id="announcement-screen" class="screen p-6 md:p-8">
            <header class="mb-6 flex justify-between items-center flex-shrink-0">
                <h2 class="text-2xl font-bold text-slate-700">공지사항</h2>
                <button id="back-to-main-from-announcement-btn" class="text-sm text-slate-500 hover:text-slate-800 transition-colors"> &lt; 처음으로</button>
            </header>
            <div id="announcement-content" class="prose max-w-none p-4 bg-white/60 rounded-lg overflow-y-auto text-base leading-relaxed flex-1 border border-stone-200/80">
                <!-- 여기에 공지사항 내용을 작성하시면 됩니다. -->
                <h3 class="font-bold">앱 업데이트 안내 (v1.1)</h3>
                <p>안녕하세요,이학민입니다. 
                    목차와 용어등은 노준화요약집을 참고하였습니다.저작권 문제가 있기에 일단 외부유출은 ㄴㄴ </p>
                <ul>
                    <li><strong>중요표시란?:</strong> 노준화요약서 기준 필수입니다. 
                    거의 원문 그대로 옮겨놨습니다. 중요표시가 없는 문제의 경우 미출제or강사도 그냥 대충 설명하고 넘어간겁니다.
                     제가 대충 요약해서 넣어놨습니다.
                     각 단원에서 중요문제가 먼저, 뒤에 몰아서 안중요문제가 나옵니다.</li>
                    <li><strong>UI 오탈자,오류,화면깨짐제보:</strong> 1실 이학민자리에 포스트잇 던져놔주세요.</li>
                </ul>
                <p>사용 중 불편한 점이나 필요기능이 있다면 꼭 피드백 부탁드립니다.</p>
                <p>감사합니다.</p>
            </div>
        </div>
        
        <div id="flashcard-screen" class="screen p-6 md:p-8">
            <div class="flex-shrink-0">
                <div id="progress-bar-container" class="w-full bg-stone-200/80 rounded-full h-1.5 mb-4">
                    <div id="progress-bar" class="bg-gradient-to-r from-sky-300 to-violet-300 h-1.5 rounded-full transition-all duration-300 ease-in-out"></div>
                </div>
                <div id="breadcrumb-container" class="mb-2"></div>
                <header class="mb-4 flex justify-between items-center space-x-4">
                    <h2 id="flashcard-title" class="text-xl font-bold text-slate-700 flex items-center min-w-0"></h2>
                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <button id="check-card-btn-placeholder" class="text-2xl text-stone-300 transition-transform duration-200 ease-in-out hover:scale-125">☆</button>
                        <button id="back-to-selection-btn" class="flex items-center space-x-2 bg-stone-200 text-stone-600 px-3 py-2 rounded-lg hover:bg-stone-300 hover:text-stone-800 transition-all text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list-ul" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                            <span>목록</span>
                        </button>
                    </div>
                </header>
            </div>
            
            <div id="flashcard-content" class="flex-1 flex flex-col space-y-4 min-h-0">
                <!-- 여기에 JS로 내용이 채워짐 -->
            </div>
            
            <div id="navigation-container" class="flex-shrink-0 pt-4">
                 <!-- 여기에 JS로 내용이 채워짐 -->
            </div>
        </div>
        
        <div id="exit-toast" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800/90 text-white text-sm py-2 px-4 rounded-full shadow-lg transition-all duration-300 opacity-0">
            한 번 더 누르면 종료됩니다.
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => console.log('ServiceWorker registration successful'))
                    .catch(error => console.log('ServiceWorker registration failed: ', error));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const CSV_URL = 'https://raw.githubusercontent.com/HacMinLee/audit-flashcard4/main/%EA%B0%90%EC%82%AC%EC%95%94%EA%B8%B0%ED%8C%8C%EC%9D%BC%EC%94%A8%EC%97%90%EC%8A%A4%EB%B9%84.csv'; 

            const screens = { 
                loading: document.getElementById('loading-screen'), 
                main: document.getElementById('main-screen'), 
                selection: document.getElementById('selection-screen'), 
                flashcard: document.getElementById('flashcard-screen'),
                announcement: document.getElementById('announcement-screen'),
                randomSelection: document.getElementById('random-selection-screen')
            };
            const loadingStatus = document.getElementById('loading-status');
            const startStudyBtn = document.getElementById('start-study-btn');
            const viewCheckedBtn = document.getElementById('view-checked-btn');
            const announcementBtn = document.getElementById('announcement-btn');
            const randomQuestionBtn = document.getElementById('random-question-btn');
            const accordionContainer = document.getElementById('accordion-container');
            const selectionTitle = document.getElementById('selection-title');
            const flashcardContent = document.getElementById('flashcard-content');
            const breadcrumbContainer = document.getElementById('breadcrumb-container');
            const flashcardTitle = document.getElementById('flashcard-title');
            const backToMainBtn = document.getElementById('back-to-main-btn');
            const backToSelectionBtn = document.getElementById('back-to-selection-btn');
            const navigationContainer = document.getElementById('navigation-container');
            const backToMainFromAnnouncementBtn = document.getElementById('back-to-main-from-announcement-btn');
            const backToMainFromRandomBtn = document.getElementById('back-to-main-from-random-btn');
            const randomAllBtn = document.getElementById('random-all-btn');
            const randomCheckedBtn = document.getElementById('random-checked-btn');
            const exitToast = document.getElementById('exit-toast');
            
            const installPwaBtn = document.getElementById('install-pwa-btn');
            let deferredPrompt;

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installPwaBtn.classList.remove('hidden');
            });

            installPwaBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installPwaBtn.classList.add('hidden');
                }
            });


            let appData = []; 
            let allCardsFlat = [];
            let currentCards = [];
            let currentCardIndex = 0;
            let checkedCardIds = JSON.parse(localStorage.getItem('checkedCardIds_v1')) || [];
            let isRandomMode = false; // 랜덤 모드 상태 변수
            let allowExit = false;
            let currentScreen = 'loading';


            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            async function fetchAndProcessData() {
                try {
                    const response = await fetch(CSV_URL);
                    if (!response.ok) throw new Error(`데이터 로딩 실패: ${response.statusText}`);
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) { 
                            appData = processCsvData(results.data); 
                            allCardsFlat = appData.flatMap(c => c.sections.flatMap(s => s.topics.flatMap(t => t.cards.map(card => ({...card, chapter: c.chapter, section: s.sectionName})))));
                            history.replaceState({ screen: 'main' }, '', '#main');
                            _displayScreen('main'); 
                        },
                        error: function(error) { throw new Error(`CSV 파싱 오류: ${error.message}`); }
                    });
                } catch (error) {
                    loadingStatus.textContent = `❌ 오류: ${error.message}`;
                    loadingStatus.classList.add('text-red-500');
                }
            }
            function processCsvData(flatData) {
                const groupedData = {};
                flatData.forEach((row, index) => {
                    if (!row.Chaper || !row.Section || !row.큰주제) return;
                    const chapter = row.Chaper.trim();
                    const section = row.Section.trim();
                    const topic = row.큰주제.trim();
                    if (!groupedData[chapter]) groupedData[chapter] = {};
                    if (!groupedData[chapter][section]) groupedData[chapter][section] = {};
                    if (!groupedData[chapter][section][topic]) groupedData[chapter][section][topic] = [];
                    groupedData[chapter][section][topic].push({ id: `${chapter}-${section}-${topic}-${index}`, section2: topic, name: row.소주제.trim(), prompt: row.표시사항.trim(), originalText: row.원문 ? row.원문.trim() : "", reference: row.기준서.trim(), importance: row.파란색여부.trim().toUpperCase() });
                });
                return Object.keys(groupedData).map(chapter => {
                    const sections = Object.keys(groupedData[chapter]).map(sectionName => {
                        const topics = Object.keys(groupedData[chapter][sectionName]).map(topicName => {
                            const cards = groupedData[chapter][sectionName][topicName];
                            return { topicName, cards, cardCount: cards.length };
                        });
                        return { sectionName, topics, totalCardCount: topics.reduce((sum, t) => sum + t.cardCount, 0) };
                    });
                    return { chapter, sections, totalCardCount: sections.reduce((sum, s) => sum + s.totalCardCount, 0) };
                });
            }
            
            function buildAccordionMenu(data) {
                accordionContainer.innerHTML = '';
                if(data.length === 0){ accordionContainer.innerHTML = '<p class="text-center text-slate-500 py-10">표시할 항목이 없습니다.</p>'; return; }
                data.forEach(chapterData => {
                    const chapterItem = document.createElement('div');
                    chapterItem.className = 'accordion-item bg-white/70 rounded-xl shadow-sm transition-shadow hover:shadow-md border border-white';
                    const chevronIcon = `<svg class="chevron w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                    chapterItem.innerHTML = `<div class="accordion-toggle p-4 cursor-pointer flex justify-between items-center font-bold text-lg text-slate-700 rounded-xl">
                                                <div class="flex items-center space-x-3">
                                                    ${chevronIcon}
                                                    <span>${chapterData.chapter}</span>
                                                </div>
                                                <span class="text-sm text-slate-500 font-medium bg-stone-200/70 px-2.5 py-1 rounded-md">${chapterData.totalCardCount}문제</span>
                                             </div>
                                             <div class="accordion-content pl-6 pr-4 pb-2 border-t border-stone-200/50"></div>`;
                    const sectionContainer = chapterItem.querySelector('.accordion-content');
                    chapterData.sections.forEach(sectionData => {
                        const sectionItem = document.createElement('div');
                        sectionItem.className = 'accordion-item py-1';
                        sectionItem.innerHTML = `<div class="accordion-toggle p-2 cursor-pointer flex justify-between items-center font-semibold text-md text-slate-600 rounded-lg hover:bg-stone-100">
                                                    <div class="flex items-center space-x-3">
                                                        ${chevronIcon}
                                                        <span>${sectionData.sectionName}</span>
                                                    </div>
                                                    <span class="text-xs text-slate-500 font-medium">${sectionData.totalCardCount}문제</span>
                                                 </div>
                                                 <div class="accordion-content pl-8"></div>`;
                        const topicContainer = sectionItem.querySelector('.accordion-content');
                        sectionData.topics.forEach(topicData => {
                            const topicItem = document.createElement('div');
                            topicItem.className = 'p-3 my-1 cursor-pointer flex justify-between items-center text-sm text-slate-600 hover:bg-sky-100/60 hover:text-sky-800 rounded-md transition-colors';
                            topicItem.innerHTML = `<span>${topicData.topicName}</span><span class="text-xs bg-sky-200/70 text-sky-800 px-2 py-1 rounded-full font-semibold">${topicData.cardCount}문제</span>`;
                            topicItem.addEventListener('click', (e) => { 
                                e.stopPropagation(); 
                                isRandomMode = false; // 일반 학습 모드
                                startStudySession(topicData.cards, chapterData.chapter, sectionData.sectionName); 
                            });
                            topicContainer.appendChild(topicItem);
                        });
                        sectionContainer.appendChild(sectionItem);
                    });
                    accordionContainer.appendChild(chapterItem);
                });
                document.querySelectorAll('.accordion-toggle').forEach(toggle => { toggle.addEventListener('click', () => { toggle.parentElement.classList.toggle('open'); }); });
            }
            
            function startStudySession(cards, chapter, section) {
                if (isRandomMode) {
                    currentCards = [...cards].map(card => ({ ...card, chapter, section })); // 랜덤 모드는 정렬 안함
                } else {
                    currentCards = [...cards].sort((a, b) => ((a.importance === 'N') ? 1 : -1) - ((b.importance === 'N') ? 1 : -1)).map(card => ({ ...card, chapter, section }));
                }
                currentCardIndex = 0;
                renderFlashcard();
                navigateTo('flashcard');
            }

            startStudyBtn.addEventListener('click', () => { selectionTitle.textContent = "목차"; buildAccordionMenu(appData); navigateTo('selection'); });
            viewCheckedBtn.addEventListener('click', () => {
                checkedCardIds = JSON.parse(localStorage.getItem('checkedCardIds_v1')) || [];
                if (checkedCardIds.length === 0) { alert('체크된 문제가 없습니다.'); return; }
                const checkedIdsSet = new Set(checkedCardIds);
                
                const checkedData = appData.map(chapter => {
                    const sections = chapter.sections.map(section => {
                        const topics = section.topics.map(topic => {
                            const checkedCards = topic.cards.filter(card => checkedIdsSet.has(card.id));
                            return { ...topic, cards: checkedCards, cardCount: checkedCards.length };
                        });
                        const sectionTotal = topics.reduce((sum, t) => sum + t.cardCount, 0);
                        return { ...section, topics, totalCardCount: sectionTotal };
                    });
                    const chapterTotal = sections.reduce((sum, s) => sum + s.totalCardCount, 0);
                    return { ...chapter, sections, totalCardCount: chapterTotal };
                });

                selectionTitle.textContent = "체크된 문제";
                buildAccordionMenu(checkedData);
                navigateTo('selection');
            });
            announcementBtn.addEventListener('click', () => navigateTo('announcement'));
            randomQuestionBtn.addEventListener('click', () => navigateTo('randomSelection'));

            randomAllBtn.addEventListener('click', () => {
                if (allCardsFlat.length === 0) { alert('문제가 없습니다.'); return; }
                isRandomMode = true;
                const shuffledCards = shuffleArray([...allCardsFlat]);
                startStudySession(shuffledCards, '랜덤', '전체 문제');
            });

            randomCheckedBtn.addEventListener('click', () => {
                checkedCardIds = JSON.parse(localStorage.getItem('checkedCardIds_v1')) || [];
                if (checkedCardIds.length === 0) { alert('체크된 문제가 없습니다.'); return; }
                const checkedIdsSet = new Set(checkedCardIds);
                const checkedCards = allCardsFlat.filter(card => checkedIdsSet.has(card.id));
                if (checkedCards.length === 0) { alert('체크된 문제가 없습니다.'); return; }
                isRandomMode = true;
                const shuffledCards = shuffleArray([...checkedCards]);
                startStudySession(shuffledCards, '랜덤', '체크된 문제');
            });

            backToMainBtn.addEventListener('click', () => history.back());
            backToMainFromAnnouncementBtn.addEventListener('click', () => history.back());
            backToMainFromRandomBtn.addEventListener('click', () => history.back());
            backToSelectionBtn.addEventListener('click', () => { 
                currentCards = []; 
                isRandomMode = false;
                history.back();
            });
            
            function _displayScreen(screenKey) { 
                if(!screens[screenKey]) return;
                Object.values(screens).forEach(s => s.classList.remove('active')); 
                screens[screenKey].classList.add('active'); 
                currentScreen = screenKey;
            }

            function navigateTo(screenKey) {
                if (currentScreen === screenKey) return;
                history.pushState({ screen: screenKey }, '', `#${screenKey}`);
                _displayScreen(screenKey);
            }
            
            window.addEventListener('popstate', (event) => {
                if (event.state && event.state.screen) {
                    allowExit = false;
                    _displayScreen(event.state.screen);
                } else {
                    if (allowExit) {
                        window.close();
                    } else {
                        exitToast.classList.remove('hidden');
                        setTimeout(() => exitToast.classList.remove('opacity-0'), 10);
                        allowExit = true;

                        setTimeout(() => {
                            exitToast.classList.add('opacity-0');
                            setTimeout(() => {
                                exitToast.classList.add('hidden');
                                allowExit = false;
                            }, 300);
                        }, 2000);
                        history.pushState({ screen: 'main' }, '', '#main');
                    }
                }
            });

            function adjustTitleFontSize(element) {
                const initialFontSize = 20; // text-xl is 1.25rem = 20px
                const minFontSize = 14;
                let currentFontSize = initialFontSize;
                element.style.fontSize = `${initialFontSize}px`;
                while (element.scrollWidth > element.clientWidth && currentFontSize > minFontSize) {
                    currentFontSize--;
                    element.style.fontSize = `${currentFontSize}px`;
                }
            }

            function renderFlashcard() {
                const headerDiv = document.querySelector('#flashcard-screen header div');
                const placeholder = document.getElementById('check-card-btn-placeholder');
                if(placeholder) placeholder.remove();
                let checkCardBtn = document.getElementById('check-card-btn');
                if (!checkCardBtn) { 
                    checkCardBtn = document.createElement('button'); 
                    checkCardBtn.id = 'check-card-btn'; 
                    checkCardBtn.className = 'text-2xl mr-1 transition-transform duration-200 ease-in-out hover:scale-125'; 
                    headerDiv.prepend(checkCardBtn); 
                }

                if (currentCards.length === 0) {
                    document.getElementById('progress-bar-container').style.display = 'none';
                    breadcrumbContainer.innerHTML = '';
                    flashcardTitle.innerHTML = "<span>표시할 카드 없음</span>";
                    flashcardContent.innerHTML = '<div class="text-center py-10"><p class="text-slate-500">선택된 카드가 없습니다.</p></div>';
                    navigationContainer.innerHTML = '';
                    checkCardBtn.style.display = 'none';
                    return;
                }
                
                document.getElementById('progress-bar-container').style.display = 'block';
                checkCardBtn.style.display = 'block';

                const card = currentCards[currentCardIndex];
                const hasKeywords = card.originalText && card.originalText.includes('<');

                const progressBar = document.getElementById('progress-bar');
                const progress = ((currentCardIndex + 1) / currentCards.length) * 100;
                progressBar.style.width = `${progress}%`;
                
                let actionButtonsHTML = '';
                if (hasKeywords) {
                    actionButtonsHTML = `
                        <div class="grid grid-cols-3 gap-3 pt-2 flex-shrink-0">
                            <button id="show-keyword-btn" class="main-btn w-full bg-gradient-to-br from-green-200 to-cyan-200 text-green-800 font-bold py-2.5 px-3 rounded-lg shadow">Keyword</button>
                            <button id="fill-blank-btn" class="main-btn w-full bg-gradient-to-br from-amber-200 to-orange-200 text-amber-800 font-bold py-2.5 px-3 rounded-lg shadow">빈칸</button>
                            <button id="show-all-btn" class="main-btn w-full bg-gradient-to-br from-sky-200 to-indigo-200 text-sky-800 font-bold py-2.5 px-3 rounded-lg shadow">전체 보기</button>
                        </div>`;
                } else {
                    actionButtonsHTML = `
                        <div class="pt-2 flex-shrink-0">
                            <button id="show-full-answer-btn" class="main-btn w-full bg-gradient-to-br from-sky-200 to-indigo-200 text-sky-800 font-bold py-4 px-6 rounded-xl shadow-lg">정답 보기</button>
                        </div>`;
                }

                flashcardContent.innerHTML = `
                    <div id="flashcard-prompt" class="p-4 rounded-lg text-base flex-shrink-0 border"></div>
                    <div id="flashcard-answer" class="p-4 bg-white/60 rounded-lg overflow-y-auto text-base leading-relaxed flex-1 border border-stone-200/80"></div>
                    ${actionButtonsHTML}`;

                navigationContainer.innerHTML = (currentCards.length > 1) ? `
                    <div class="flex justify-between items-center">
                        <button id="prev-card-btn" class="main-btn bg-stone-200/80 text-stone-600 p-3 rounded-full shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
                        </button>
                        <span id="card-progress" class="text-sm font-medium text-slate-600 tabular-nums"></span>
                        <button id="next-card-btn" class="main-btn bg-stone-200/80 text-stone-600 p-3 rounded-full shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/></svg>
                        </button>
                    </div>` : '';
                
                const importanceTagHTML = card.importance === 'Y' ? '<span class="ml-2 text-xs align-middle font-semibold text-sky-600 border border-sky-300 bg-sky-100 px-2 py-0.5 rounded-full flex-shrink-0">중요</span>' : '';
                flashcardTitle.innerHTML = `<span>${card.name || "플래시카드"}</span>` + importanceTagHTML;

                adjustTitleFontSize(flashcardTitle);
                
                breadcrumbContainer.innerHTML = `<div class="text-xs text-stone-500 bg-stone-100 p-2 rounded-lg flex items-center flex-wrap">
                                                    <span class="font-semibold text-stone-700">${card.chapter}</span>
                                                    <span class="mx-1.5 text-stone-400">&gt;</span>
                                                    <span class="font-medium text-stone-600">${card.section}</span>
                                                    <span class="mx-1.5 text-stone-400">&gt;</span>
                                                    <span class="text-stone-500">${card.section2}</span>
                                                 </div>`;
                
                document.getElementById('flashcard-prompt').textContent = card.prompt;
                const answerEl = document.getElementById('flashcard-answer');
                answerEl.innerHTML = '<p class="text-stone-400">아래 버튼을 눌러 정답을 확인하세요.</p>';
                if(currentCards.length > 1) {
                    document.getElementById('card-progress').textContent = `${currentCardIndex + 1} / ${currentCards.length}`;
                }
                document.getElementById('flashcard-prompt').className = 'p-4 rounded-lg text-base transition-colors duration-300 bg-amber-50 text-amber-800 border-amber-200/80 flex-shrink-0'; 
                
                const isChecked = checkedCardIds.includes(card.id);
                checkCardBtn.innerHTML = isChecked ? '★' : '☆'; 
                checkCardBtn.classList.toggle('text-yellow-400', isChecked);
                checkCardBtn.classList.toggle('text-stone-300', !isChecked);
                
                if (currentCards.length > 1) {
                    const prevCardBtn = document.getElementById('prev-card-btn');
                    const nextCardBtn = document.getElementById('next-card-btn');
                    prevCardBtn.disabled = currentCardIndex === 0; 
                    nextCardBtn.disabled = currentCardIndex === currentCards.length - 1; 
                    prevCardBtn.classList.toggle('opacity-50', prevCardBtn.disabled); 
                    nextCardBtn.classList.toggle('opacity-50', nextCardBtn.disabled); 
                    prevCardBtn.onclick = () => { if (currentCardIndex > 0) { currentCardIndex--; renderFlashcard(); } };
                    nextCardBtn.onclick = () => { if (currentCardIndex < currentCards.length - 1) { currentCardIndex++; renderFlashcard(); } };
                }
                
                const revealAnswer = (mode) => {
                    if (currentCards.length === 0) return;
                    const newContent = parseOriginalText(currentCards[currentCardIndex].originalText, mode);
                    answerEl.style.opacity = '0';
                    setTimeout(() => {
                        answerEl.innerHTML = newContent;
                        answerEl.style.opacity = '1';
                    }, 200);
                };

                checkCardBtn.onclick = toggleCheckStatus;

                if (hasKeywords) {
                    document.getElementById('show-keyword-btn').onclick = () => revealAnswer('keyword');
                    document.getElementById('fill-blank-btn').onclick = () => revealAnswer('blank');
                    document.getElementById('show-all-btn').onclick = () => revealAnswer('all');
                } else {
                    document.getElementById('show-full-answer-btn').onclick = () => revealAnswer('all');
                }
            }

            function toggleCheckStatus() { 
                if (currentCards.length === 0) return;
                const cardId = currentCards[currentCardIndex].id; 
                const index = checkedCardIds.indexOf(cardId); 
                if (index > -1) checkedCardIds.splice(index, 1);
                else checkedCardIds.push(cardId);
                localStorage.setItem('checkedCardIds_v1', JSON.stringify(checkedCardIds)); 
                const checkCardBtn = document.getElementById('check-card-btn');
                const isChecked = checkedCardIds.includes(cardId);
                checkCardBtn.innerHTML = isChecked ? '★' : '☆';
                checkCardBtn.classList.toggle('text-yellow-400', isChecked);
                checkCardBtn.classList.toggle('text-stone-300', !isChecked);
            }
            function parseOriginalText(text = '', mode) { 
                const sentences = text.split('|').map(s => s.trim().replace(/\n/g, '<br>')); 
                let htmlResult = ''; 
                sentences.forEach(sentence => { 
                    let processedSentence = sentence.replace(/<(.+?)>/g, (match, p1) => { 
                        if (mode === 'keyword') return `<span class="inline-block bg-green-100/70 text-green-800 font-bold px-2 py-0.5 rounded-md m-0.5">${p1}</span>`; 
                        if (mode === 'blank') return '<span class="font-bold text-amber-600">[____]</span>'; 
                        return `<strong class="text-sky-700 font-semibold">${p1}</strong>`; 
                    }); 
                    if (mode === 'keyword') { processedSentence = (sentence.match(/<(.+?)>/g) || []).map(kw => `<span class="inline-block bg-green-100/70 text-green-800 font-bold px-2 py-0.5 rounded-md m-0.5">${kw.replace(/[<>]/g, '')}</span>`).join(' '); } 
                    htmlResult += `<p class="mb-3">${processedSentence}</p>`; 
                }); 
                return htmlResult; 
            }
            fetchAndProcessData();
        });
    </script>
</body>
</html>














